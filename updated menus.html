<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAPC-GG LTD Business Suite & Accounting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google API for Drive -->
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    /* Basic Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    /* Navigation Menu */
    nav {
      background: #34495e;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      color: #fff;
      font-size: 1.5rem;
      font-weight: bold;
    }
    nav ul {
      list-style-type: none;
      display: flex;
    }
    nav ul li {
      margin-left: 1rem;
    }
    nav ul li a {
      color: #fff;
      text-decoration: none;
      padding: 0.5rem 1rem;
      transition: background 0.3s ease;
    }
    nav ul li a:hover,
    nav ul li a.active {
      background: #2c3e50;
      border-radius: 4px;
    }
    /* Page Sections */
    section {
      display: none;
      padding: 1rem;
    }
    section.active {
      display: block;
    }
    /* Common Container */
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
    }
    /* Body Background */
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #333;
      min-height: 100vh;
    }
    /* Login/Account Creation Styling */
    #loginContainer {
      max-width: 400px;
      margin: 8% auto;
      background: rgba(255,255,255,0.95);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: center;
    }
    #loginContainer input {
      width: 90%;
      padding: 0.7rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #loginContainer button {
      width: 95%;
      padding: 0.7rem;
      margin-top: 0.5rem;
      font-size: 1rem;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #loginContainer button:hover {
      background: #0056b3;
    }
    #loginMsg {
      color: red;
      font-weight: bold;
    }
    /* Main System Styling (Home) */
    #mainSystem {
      display: none;
      margin-top: 1rem;
      background: rgba(255,255,255,0.97);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      margin-bottom: 2rem;
    }
    h1, h2 {
      text-align: center;
    }
    .btn-group {
      text-align: center;
      margin-bottom: 1rem;
    }
    .btn-group button {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-add { background-color: #007bff; color: #fff; }
    .btn-export { background-color: #28a745; color: #fff; }
    .btn-cloud { background-color: #6c757d; color: #fff; }
    .btn-remove { background-color: #dc3545; color: #fff; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
      background: #fff;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.6rem;
      text-align: center;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 90%;
      padding: 0.3rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
    }
    /* Logout Button */
    #logoutBtn {
      float: right;
      margin-right: 1rem;
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #logoutBtn:hover {
      background: #c82333;
    }
    /* Bookkeeping Section Styles */
    #bookkeeping {
      background: rgba(255,255,255,0.97);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      margin-bottom: 2rem;
    }
    /* Sub-menu for Bookkeeping */
    .bk-nav {
      text-align: center;
      margin-bottom: 1rem;
    }
    .bk-nav button {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #007bff;
      color: #fff;
    }
    .bk-nav button.active {
      background: #0056b3;
    }
    .bookkeeping-section {
      display: none;
    }
    .bookkeeping-section.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Navigation Menu -->
  <nav>
    <div class="logo">CAPC-GG LTD</div>
    <ul>
      <li><a href="#" class="active" onclick="showSection('home')">Home</a></li>
      <li><a href="#" onclick="showSection('bookkeeping')">Bookkeeping</a></li>
    </ul>
  </nav>
  
  <!-- Home Section -->
  <section id="home" class="active">
    <!-- Login / Account Creation Container -->
    <div id="loginContainer">
      <h2>Welcome to CAPC-GG LTD Business Suite</h2>
      <p>Please log in or create an account</p>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="pin" placeholder="PIN / Password">
      <button onclick="login()">Login</button>
      <button onclick="createAccount()">Create Account</button>
      <p id="loginMsg"></p>
    </div>

    <!-- Main System Container -->
    <div id="mainSystem" class="container">
      <button id="logoutBtn" onclick="logout()">Logout</button>
      <h1>CAPC-GG LTD Business Suite</h1>
      <p>Manage your items with tax calculations and export your data.</p>
      
      <div class="btn-group">
        <button class="btn-add" onclick="addRow()">Add Item</button>
        <button class="btn-export" onclick="exportTableToCSV('items_data')">Export to CSV</button>
        <button class="btn-cloud" onclick="saveToGoogleDrive()">Save to Google Drive</button>
      </div>
      
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Quantity Units</th>
            <th>Unit Price (RWF)</th>
            <th>Tax Exempt?</th>
            <th>18% Tax (per unit)</th>
            <th>3% Tax (per unit)</th>
            <th>8% Profit (per unit)</th>
            <th>Total Profit</th>
            <th>Total Price</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will appear here -->
        </tbody>
      </table>
    </div>
  </section>
  
  <!-- Bookkeeping Section -->
  <section id="bookkeeping">
    <div class="container">
      <h2>Bookkeeping / Transaction Recording</h2>
      <!-- Bookkeeping Sub-Menu -->
      <div class="bk-nav">
        <button id="btnNewTxn" class="active" onclick="showBookkeepingSection('newTransaction')">New Transaction</button>
        <button id="btnLedger" onclick="showBookkeepingSection('ledger')">Ledger</button>
        <button id="btnReports" onclick="showBookkeepingSection('reports')">Reports</button>
      </div>
      
      <!-- New Transaction Form -->
      <div id="newTransaction" class="bookkeeping-section active">
        <h3>Record a New Transaction</h3>
        <form id="transactionForm" onsubmit="recordTransaction(event)">
          <label>
            Date:
            <input type="date" id="txnDate" required>
          </label><br><br>
          <label>
            Transaction Type:
            <select id="txnType" required>
              <option value="Debit">Debit</option>
              <option value="Credit">Credit</option>
            </select>
          </label><br><br>
          <label>
            Account:
            <input type="text" id="txnAccount" placeholder="e.g., Sales, Expenses" required>
          </label><br><br>
          <label>
            Amount:
            <input type="number" id="txnAmount" placeholder="Amount" step="0.01" required>
          </label><br><br>
          <label>
            Description:
            <textarea id="txnDescription" placeholder="Enter a description"></textarea>
          </label><br><br>
          <button type="submit">Record Transaction</button>
        </form>
      </div>
      
      <!-- Ledger Section -->
      <div id="ledger" class="bookkeeping-section">
        <h3>Ledger Entries</h3>
        <table id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Account</th>
              <th>Amount</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <!-- Ledger rows will be added here -->
          </tbody>
        </table>
      </div>
      
      <!-- Reports Section -->
      <div id="reports" class="bookkeeping-section">
        <h3>Accounting Reports</h3>
        <div id="reportSummary">
          <!-- Summary report will be generated here -->
        </div>
      </div>
    </div>
  </section>
  
  <script>
    /*********************************
     * GLOBAL VARIABLES *
     *********************************/
    let transactions = [];

    /*********************************
     * NAVIGATION HANDLER *
     *********************************/
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      // Remove active class from all nav links
      document.querySelectorAll("nav ul li a").forEach(link => link.classList.remove("active"));
      // Show selected section
      document.getElementById(sectionId).classList.add("active");
      // Mark corresponding nav link active
      document.querySelectorAll("nav ul li a").forEach(link => {
        if (link.textContent.trim().toLowerCase() === sectionId) {
          link.classList.add("active");
        }
      });
    }
    
    function showBookkeepingSection(sectionId) {
      // Hide all bookkeeping sub-sections
      document.querySelectorAll(".bookkeeping-section").forEach(sec => sec.classList.remove("active"));
      // Remove active style from bookkeeping nav buttons
      document.querySelectorAll(".bk-nav button").forEach(btn => btn.classList.remove("active"));
      // Show the requested bookkeeping section
      document.getElementById(sectionId).classList.add("active");
      // Mark corresponding bookkeeping nav button as active
      if(sectionId === "newTransaction"){
        document.getElementById("btnNewTxn").classList.add("active");
      } else if(sectionId === "ledger"){
        document.getElementById("btnLedger").classList.add("active");
        updateLedger();
      } else if(sectionId === "reports"){
        document.getElementById("btnReports").classList.add("active");
        updateReports();
      }
    }

    /*********************************
     * SECURITY SYSTEM (Enhanced) *
     *********************************/
    async function hashString(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    async function createAccount() {
      const username = document.getElementById('username').value.trim();
      const pin = document.getElementById('pin').value.trim();
      if (!username || !pin) {
        document.getElementById('loginMsg').innerText = "Please enter both username and PIN.";
        return;
      }
      if (pin.length < 6) {
        document.getElementById('loginMsg').innerText = "PIN must be at least 6 characters long.";
        return;
      }
      if (localStorage.getItem("user_" + username)) {
        document.getElementById('loginMsg').innerText = "Account already exists. Please log in.";
      } else {
        const hashedPin = await hashString(pin);
        localStorage.setItem("user_" + username, hashedPin);
        document.getElementById('loginMsg').innerText = "Account created! You can now log in.";
      }
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const pin = document.getElementById('pin').value.trim();
      if (!username || !pin) {
        document.getElementById('loginMsg').innerText = "Please enter both username and PIN.";
        return;
      }
      const storedHashedPin = localStorage.getItem("user_" + username);
      const enteredHashedPin = await hashString(pin);
      if (storedHashedPin && storedHashedPin === enteredHashedPin) {
        localStorage.setItem("currentUser", username);
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainSystem').style.display = 'block';
        initGapiClient();  // Initialize Google API client for Drive

        // Prepopulate 100 empty rows only if the table is empty.
        const tableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
        if (tableBody.rows.length === 0) {
          for (let i = 0; i < 100; i++) {
            addRow();
          }
        }
      } else {
        document.getElementById('loginMsg').innerText = "Invalid username or PIN.";
      }
    }

    function logout() {
      localStorage.removeItem("currentUser");
      document.getElementById('mainSystem').style.display = 'none';
      document.getElementById('loginContainer').style.display = 'block';
    }

    /*********************************
     * ITEMS TABLE SYSTEM (Home) *
     *********************************/
    function addRow(item = {}) {
      const tableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
      const newRow = tableBody.insertRow();

      // Column 0: Item Name
      const cellName = newRow.insertCell();
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = 'Item Name';
      nameInput.value = item['Item Name'] || '';
      cellName.appendChild(nameInput);

      // Column 1: Description
      const cellDesc = newRow.insertCell();
      const descInput = document.createElement('input');
      descInput.type = 'text';
      descInput.placeholder = 'Description';
      descInput.value = item['Description'] || '';
      cellDesc.appendChild(descInput);

      // Column 2: Quantity
      const cellQty = newRow.insertCell();
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.placeholder = 'Quantity';
      qtyInput.step = '1';
      qtyInput.min = '0';
      qtyInput.value = item['Quantity'] || '';
      qtyInput.addEventListener('input', function() {
        updateRowCalculations(newRow);
      });
      cellQty.appendChild(qtyInput);

      // Column 3: Quantity Units
      const cellQtyUnits = newRow.insertCell();
      const qtyUnitInput = document.createElement('input');
      qtyUnitInput.type = 'text';
      qtyUnitInput.placeholder = 'Units (e.g., pcs, kg)';
      qtyUnitInput.value = item['Quantity Units'] || '';
      cellQtyUnits.appendChild(qtyUnitInput);

      // Column 4: Unit Price (RWF)
      const cellPrice = newRow.insertCell();
      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.placeholder = 'Unit Price';
      priceInput.step = '0.01';
      priceInput.value = item['Unit Price (RWF)'] || '';
      priceInput.addEventListener('input', function() {
        updateRowCalculations(newRow);
      });
      cellPrice.appendChild(priceInput);

      // Column 5: Tax Exempt Checkbox
      const cellTaxExempt = newRow.insertCell();
      const exemptCheckbox = document.createElement('input');
      exemptCheckbox.type = 'checkbox';
      exemptCheckbox.checked = (item['Tax Exempt?'] && item['Tax Exempt?'].toLowerCase() === "yes") || false;
      exemptCheckbox.addEventListener('change', function() {
        updateRowCalculations(newRow);
      });
      cellTaxExempt.appendChild(exemptCheckbox);

      // Column 6: 18% Tax (per unit)
      const cellTax18 = newRow.insertCell();
      cellTax18.innerText = '0.00';

      // Column 7: 3% Tax (per unit)
      const cellTax3 = newRow.insertCell();
      cellTax3.innerText = '0.00';

      // Column 8: 8% Profit (per unit)
      const cellProfit = newRow.insertCell();
      cellProfit.innerText = '0.00';

      // Column 9: Total Profit (for the row)
      const cellTotalProfit = newRow.insertCell();
      cellTotalProfit.innerText = '0.00';

      // Column 10: Total Price (for the row)
      const cellTotal = newRow.insertCell();
      cellTotal.innerText = '0.00';

      // Column 11: Action (Remove Button)
      const cellAction = newRow.insertCell();
      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn-remove';
      removeBtn.innerText = 'Remove';
      removeBtn.onclick = function() { newRow.remove(); };
      cellAction.appendChild(removeBtn);

      // Update calculations if data exists.
      if (item['Unit Price (RWF)'] || item['Quantity']) {
        updateRowCalculations(newRow);
      }
    }

    function updateRowCalculations(row) {
      const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
      const unitPrice = parseFloat(row.cells[4].querySelector('input').value) || 0;
      const taxExempt = row.cells[5].querySelector('input').checked;

      const unitTax18 = taxExempt ? 0 : unitPrice * 0.18;
      const unitTax3  = taxExempt ? 0 : unitPrice * 0.03;
      const unitProfit = unitPrice * 0.08;
      const unitTotal = unitPrice + unitTax18 + unitTax3 + unitProfit;

      const rowTotalProfit = unitProfit * qty;
      const rowTotalPrice = unitTotal * qty;
      
      row.cells[6].innerText = unitTax18.toFixed(2);
      row.cells[7].innerText = unitTax3.toFixed(2);
      row.cells[8].innerText = unitProfit.toFixed(2);
      row.cells[9].innerText = rowTotalProfit.toFixed(2);
      row.cells[10].innerText = rowTotalPrice.toFixed(2);
    }

    function exportTableToCSV(filename) {
      let csvContent = "";
      const rows = document.querySelectorAll("#itemsTable tr");
      rows.forEach(row => {
        let rowData = [];
        row.querySelectorAll("th, td").forEach((cell, index) => {
          if (index < row.cells.length - 1) { // Exclude the Action column
            let text = cell.innerText;
            const input = cell.querySelector("input");
            if (input) {
              text = input.type === "checkbox" ? (input.checked ? "Yes" : "No") : input.value;
            }
            rowData.push('"' + text + '"');
          }
        });
        csvContent += rowData.join(",") + "\n";
      });
      downloadCSV(csvContent, filename);
    }

    function downloadCSV(csvContent, filename) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /******************************************
     * GOOGLE DRIVE API INTEGRATION *
     ******************************************/
    const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
    const API_KEY = 'YOUR_GOOGLE_API_KEY';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    function initGapiClient() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        });
      });
    }

    function saveToGoogleDrive() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        let csvContent = "";
        const rows = document.querySelectorAll("#itemsTable tr");
        rows.forEach(row => {
          let rowData = [];
          row.querySelectorAll("th, td").forEach((cell, index) => {
            if (index < row.cells.length - 1) {
              let text = cell.innerText;
              const input = cell.querySelector("input");
              if (input) {
                text = input.type === "checkbox" ? (input.checked ? "Yes" : "No") : input.value;
              }
              rowData.push('"' + text + '"');
            }
          });
          csvContent += rowData.join(",") + "\n";
        });
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        const contentType = 'text/csv';
        const metadata = {
          'name': 'items_data.csv',
          'mimeType': contentType
        };
        const base64Data = btoa(unescape(encodeURIComponent(csvContent)));
        const multipartRequestBody =
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + contentType + '\r\n' +
              'Content-Transfer-Encoding: base64\r\n' +
              '\r\n' +
              base64Data +
              close_delim;

        gapi.client.request({
          'path': '/upload/drive/v3/files',
          'method': 'POST',
          'params': {'uploadType': 'multipart'},
          'headers': {
            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
          },
          'body': multipartRequestBody
        }).then(function(file) {
          alert("Data saved to Google Drive successfully!");
        }, function(error) {
          console.error("Error uploading file: ", error);
          alert("Error saving data to Google Drive.");
        });
      });
    }
    
    /*********************************
     * BOOKKEEPING FUNCTIONS *
     *********************************/
    // Record a new transaction from the form.
    function recordTransaction(event) {
      event.preventDefault();
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const account = document.getElementById('txnAccount').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
      const description = document.getElementById('txnDescription').value.trim();
      
      const transaction = { date, type, account, amount, description };
      transactions.push(transaction);
      alert("Transaction recorded.");
      document.getElementById('transactionForm').reset();
    }
    
    // Update ledger table with recorded transactions.
    function updateLedger() {
      const ledgerBody = document.getElementById('ledgerTable').getElementsByTagName('tbody')[0];
      ledgerBody.innerHTML = "";
      transactions.forEach(txn => {
        const row = ledgerBody.insertRow();
        row.insertCell().innerText = txn.date;
        row.insertCell().innerText = txn.type;
        row.insertCell().innerText = txn.account;
        row.insertCell().innerText = txn.amount.toFixed(2);
        row.insertCell().innerText = txn.description;
      });
    }
    
    // Update reports section with summary data.
    function updateReports() {
      let totalDebit = 0, totalCredit = 0;
      const accountSummary = {};
      
      transactions.forEach(txn => {
        if(txn.type === "Debit"){
          totalDebit += txn.amount;
        } else {
          totalCredit += txn.amount;
        }
        // Group by account.
        if(!accountSummary[txn.account]){
          accountSummary[txn.account] = { Debit: 0, Credit: 0 };
        }
        accountSummary[txn.account][txn.type] += txn.amount;
      });
      
      let reportHTML = `<h4>Overall Totals:</h4>
                        <p>Total Debit: ${totalDebit.toFixed(2)}</p>
                        <p>Total Credit: ${totalCredit.toFixed(2)}</p>
                        <p>Net Balance: ${(totalDebit - totalCredit).toFixed(2)}</p>
                        <h4>By Account:</h4>
                        <table style="width:100%; border-collapse: collapse;" border="1">
                          <thead>
                            <tr>
                              <th>Account</th>
                              <th>Total Debit</th>
                              <th>Total Credit</th>
                              <th>Net</th>
                            </tr>
                          </thead>
                          <tbody>`;
      for (const acc in accountSummary) {
        const debit = accountSummary[acc].Debit;
        const credit = accountSummary[acc].Credit;
        reportHTML += `<tr>
                         <td>${acc}</td>
                         <td>${debit.toFixed(2)}</td>
                         <td>${credit.toFixed(2)}</td>
                         <td>${(debit - credit).toFixed(2)}</td>
                       </tr>`;
      }
      reportHTML += `</tbody></table>`;
      document.getElementById('reportSummary').innerHTML = reportHTML;
    }
  </script>
</body>
</html>
